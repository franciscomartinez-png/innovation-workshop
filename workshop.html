<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruta de Innovacion 2026 â€” AquaChile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #F9F8F8;
      --surface: #ffffff;
      --text: #141414;
      --text-2: #434549;
      --text-3: #8a8d93;
      --primary: #FF7600;
      --primary-light: #FFF4EB;
      --primary-dark: #E06800;
      --amber: #FF7600;
      --amber-light: #FFF4EB;
      --amber-border: #FFB870;
      --green: #65bd7d;
      --green-light: #edf8f0;
      --blue: #198fd9;
      --blue-light: #e8f4fc;
      --rose: #e11d48;
      --rose-light: #fff1f2;
      --border: #e5e5e5;
      --radius: 6px;
      --shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.03);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.07);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    body::before {
      content: '';
      display: block;
      height: 3px;
      background: linear-gradient(90deg, #FF7600, #FFa040, #FF7600);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }

    /* -- Header -- */
    header {
      background: #141414;
      padding: 20px 24px 0;
      position: sticky;
      top: 3px;
      z-index: 50;
    }

    .header-inner {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 6px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 6px;
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      font-size: 0.85rem;
      flex-shrink: 0;
      transition: all 150ms ease;
    }

    .back-link:hover {
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.9);
    }

    .logo {
      font-size: 1.05rem;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: -0.01em;
    }

    .logo-accent {
      color: var(--primary);
      font-weight: 700;
    }

    .logo-sub {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.35);
      font-weight: 400;
    }

    .area-subtitle {
      max-width: 800px;
      margin: 0 auto;
      padding: 4px 0 12px;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.4);
      font-weight: 400;
      padding-left: 42px;
    }

    /* -- Step Nav -- */
    .step-nav {
      background: #141414;
      padding: 0 24px 16px;
      position: sticky;
      top: 3px;
      z-index: 50;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .step-nav::-webkit-scrollbar { display: none; }

    .step-nav-inner {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 6px;
    }

    .step-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      background: transparent;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.8rem;
      font-family: inherit;
      transition: all 150ms ease;
    }

    .step-pill:hover {
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.8);
    }

    .step-pill.active {
      background: #ffffff;
      color: var(--text);
      border-color: #ffffff;
      font-weight: 600;
    }

    .step-num {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      background: rgba(255,255,255,0.12);
      flex-shrink: 0;
    }

    .step-pill.active .step-num {
      background: var(--primary);
      color: #ffffff;
    }

    .step-pill.completed .step-num::after {
      content: '\2713';
    }

    .step-label { display: none; }

    @media (min-width: 768px) {
      .step-label { display: inline; }
    }

    /* -- Main Content -- */
    main {
      max-width: 800px;
      margin: 0 auto;
      padding: 32px 24px 80px;
    }

    /* -- Step Header -- */
    .step-header {
      margin-bottom: 24px;
    }

    .step-header-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .step-number {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--primary);
      background: var(--primary-light);
      padding: 3px 10px;
      border-radius: 12px;
    }

    .step-duration {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-3);
      background: var(--bg);
      padding: 3px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .step-title {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--text);
      line-height: 1.3;
    }

    .step-subtitle {
      font-size: 0.95rem;
      color: var(--text-2);
      margin-top: 2px;
    }

    /* -- Callout -- */
    .callout {
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .callout-tip {
      background: var(--blue-light);
      color: #0d6eaa;
      border: 1px solid #b3daf0;
    }

    .callout-action {
      background: var(--primary-light);
      color: #9a4500;
      border: 1px solid var(--amber-border);
    }

    .callout-human {
      background: var(--rose-light);
      color: #9f1239;
      border: 1px solid #fecdd3;
    }

    .callout strong {
      font-weight: 600;
    }

    /* -- Path Toggle -- */
    .path-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .path-btn {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      cursor: pointer;
      text-align: center;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-2);
      transition: all 150ms ease;
      line-height: 1.4;
    }

    .path-btn:hover {
      border-color: var(--amber-border);
      background: var(--bg);
    }

    .path-btn.active {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    /* -- Fields Section -- */
    .fields-section {
      background: var(--amber-light);
      border: 1px solid var(--amber-border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }

    .fields-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--amber);
      margin-bottom: 14px;
    }

    .field-group {
      margin-bottom: 14px;
    }

    .field-group:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 4px;
    }

    .field-input,
    .field-textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--amber-border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      color: var(--text);
      background: #ffffff;
      transition: border-color 150ms ease;
    }

    .field-input:focus,
    .field-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 118, 0, 0.1);
    }

    .field-textarea {
      min-height: 64px;
      resize: vertical;
      line-height: 1.5;
    }

    .field-input::placeholder,
    .field-textarea::placeholder {
      color: #d4a06a;
    }

    /* -- Prompt Card -- */
    .prompt-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--primary);
      border-radius: 2px var(--radius) var(--radius) 2px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .prompt-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: #fafbfc;
      border-bottom: 1px solid var(--border);
    }

    .prompt-card-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-3);
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: var(--primary);
      color: #ffffff;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 150ms ease;
      box-shadow: 0 2px 8px rgba(255, 118, 0, 0.3);
    }

    .copy-btn:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(255, 118, 0, 0.4);
      transform: translateY(-1px);
    }

    .copy-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(255, 118, 0, 0.3);
    }

    .copy-btn.copied {
      background: var(--green);
      border-color: var(--green);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(101, 189, 125, 0.4);
    }

    .copy-btn svg {
      width: 16px;
      height: 16px;
    }

    .prompt-text {
      padding: 20px;
      font-size: 0.9rem;
      line-height: 1.75;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .prompt-text .field-highlight {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 1px 6px;
      border-radius: 3px;
      border: 1px solid var(--amber-border);
      font-weight: 500;
    }

    /* -- Nav Buttons -- */
    .step-nav-btns {
      display: flex;
      justify-content: space-between;
      margin-top: 28px;
      gap: 12px;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text-2);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }

    .nav-btn:hover {
      background: var(--bg);
      border-color: var(--text-3);
    }

    .nav-btn-next {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
      margin-left: auto;
    }

    .nav-btn-next:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* -- Challenge Reference -- */
    .challenge-ref {
      margin-bottom: 20px;
    }

    .challenge-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text-2);
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 150ms ease;
    }

    .challenge-toggle:hover {
      background: var(--bg);
    }

    .challenge-toggle .arrow {
      transition: transform 200ms ease;
      font-size: 0.7rem;
    }

    .challenge-toggle.open .arrow {
      transform: rotate(90deg);
    }

    .challenge-panel {
      display: none;
      margin-top: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .challenge-panel.open {
      display: block;
    }

    .challenge-pillar {
      border-bottom: 1px solid var(--border);
    }

    .challenge-pillar:last-child {
      border-bottom: none;
    }

    .pillar-name {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 10px 16px;
      background: #f8fafc;
      color: var(--text-2);
    }

    .challenge-item {
      padding: 10px 16px;
      font-size: 0.82rem;
      color: var(--text-2);
      border-top: 1px solid #f1f5f9;
      line-height: 1.5;
      cursor: pointer;
      transition: background 100ms ease;
    }

    .challenge-item:hover {
      background: var(--primary-light);
    }

    .challenge-item strong {
      color: var(--text);
      font-weight: 600;
    }

    /* -- Submit CTA -- */
    .submit-cta {
      margin-top: 28px;
      background: linear-gradient(135deg, #FF7600 0%, #E06800 100%);
      border-radius: var(--radius);
      padding: 32px 28px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(255, 118, 0, 0.3), 0 0 0 1px rgba(255, 118, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .submit-cta::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.03) 10px,
        rgba(255,255,255,0.03) 20px
      );
    }

    .submit-cta-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      position: relative;
    }

    .submit-cta-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
      position: relative;
    }

    .submit-cta-desc {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      margin-bottom: 20px;
      position: relative;
    }

    .submit-cta-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 16px 40px;
      background: #ffffff;
      color: var(--primary);
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      text-decoration: none;
      transition: all 200ms ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .submit-cta-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -60%;
      width: 40%;
      height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,118,0,0.15), transparent);
      transform: skewX(-20deg);
      animation: btn-shimmer 2.5s ease-in-out infinite;
    }

    @keyframes btn-shimmer {
      0% { left: -60%; }
      100% { left: 160%; }
    }

    .submit-cta-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(0,0,0,0.25);
      background: #fffaf5;
    }

    .submit-cta-btn:active {
      transform: scale(0.97);
    }

    .submit-cta-btn svg {
      width: 20px;
      height: 20px;
    }

    @keyframes pulse-ring {
      0% { box-shadow: 0 4px 20px rgba(255, 118, 0, 0.3), 0 0 0 0 rgba(255, 118, 0, 0.5); }
      70% { box-shadow: 0 4px 20px rgba(255, 118, 0, 0.3), 0 0 0 14px rgba(255, 118, 0, 0); }
      100% { box-shadow: 0 4px 20px rgba(255, 118, 0, 0.3), 0 0 0 0 rgba(255, 118, 0, 0); }
    }

    .submit-cta {
      animation: pulse-ring 2s ease-out infinite;
    }

    /* -- Celebration Canvas -- */
    #celebration-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    /* -- Floating Emojis -- */
    .emoji-float {
      position: fixed;
      font-size: 2rem;
      pointer-events: none;
      z-index: 9998;
      animation: emoji-rise 3s ease-out forwards;
    }

    @keyframes emoji-rise {
      0% { opacity: 1; transform: translateY(0) scale(0.5) rotate(0deg); }
      20% { opacity: 1; transform: translateY(-60px) scale(1.2) rotate(20deg); }
      100% { opacity: 0; transform: translateY(-400px) scale(0.8) rotate(40deg); }
    }

    /* -- Screen flash -- */
    .screen-flash {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 10000;
      pointer-events: none;
      animation: flash-out 0.6s ease-out forwards;
    }

    @keyframes flash-out {
      0% { opacity: 0.7; }
      100% { opacity: 0; }
    }

    /* -- Fade transition -- */
    .fade-in {
      animation: fadeIn 200ms ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* -- Coming Soon Container -- */
    .coming-soon-container {
      max-width: 520px;
      margin: 100px auto 0;
      text-align: center;
      padding: 0 24px;
    }

    .coming-soon-container h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.03em;
      margin-bottom: 12px;
    }

    .coming-soon-container p {
      font-size: 1rem;
      color: var(--text-2);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .coming-soon-container .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 28px;
      background: var(--primary);
      color: #ffffff;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      text-decoration: none;
      transition: all 150ms ease;
    }

    .coming-soon-container .back-btn:hover {
      background: var(--primary-dark);
    }

    /* -- Loading state -- */
    .loading-container {
      max-width: 520px;
      margin: 100px auto 0;
      text-align: center;
      padding: 0 24px;
      color: var(--text-3);
      font-size: 0.95rem;
    }

    /* -- Responsive -- */
    @media (max-width: 600px) {
      main { padding: 20px 16px 80px; }
      .step-title { font-size: 1.3rem; }
      .path-toggle { flex-direction: column; }
      .prompt-text { padding: 16px; font-size: 0.85rem; }
      .fields-section { padding: 16px; }
      .header-inner { padding-bottom: 4px; }
      .area-subtitle { padding-left: 42px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <a class="back-link" href="index.html" title="Volver">&larr;</a>
      <div class="logo"><span class="logo-accent" id="header-title">Ruta de Innovacion 2026</span> &mdash; AquaChile</div>
      <span class="logo-sub">by brinca.com</span>
    </div>
    <div class="area-subtitle" id="area-subtitle"></div>
  </header>

  <nav class="step-nav" id="step-nav-wrapper" style="display:none;">
    <div class="step-nav-inner" id="step-nav"></div>
  </nav>

  <main>
    <div id="step-content">
      <div class="loading-container">Cargando...</div>
    </div>
  </main>

<script>
// =====================================================
// DATA-DRIVEN WORKSHOP ENGINE
// =====================================================

// -- i18n Strings --
var I18N = {
  es: {
    headerTitle: "Ruta de Innovacion 2026",
    step: "Paso",
    tipLabel: "Consejo",
    actionLabel: "Importante",
    humanLabel: "Paso presencial primero",
    copy: "Copiar",
    copied: "\u00a1Copiado!",
    prev: "\u2190 Anterior",
    next: "Siguiente \u2192",
    promptLabel: "Prompt para copiar en Copilot",
    fillDetails: "Completa tus datos",
    openForm: "Abrir Formulario de Postulacion",
    finalStep: "Paso Final",
    submitTitle: "Postula tu idea a la Ruta de Innovacion 2026",
    submitDesc: "Copia el resultado de Copilot y pegalo en el formulario de postulacion.",
    viewChallenges: "Ver los {{N}} desafios",
    comingSoonTitle: "Este taller estara disponible proximamente",
    comingSoonSub: "Estamos preparando el material de apoyo para tu area. Vuelve pronto!",
    backToSelector: "Volver al selector",
    challengePrefix: "Desafio",
    loading: "Cargando..."
  },
  en: {
    headerTitle: "Innovation Route 2026",
    step: "Step",
    tipLabel: "Tip",
    actionLabel: "Important",
    humanLabel: "Human step first",
    copy: "Copy",
    copied: "Copied!",
    prev: "\u2190 Previous",
    next: "Next \u2192",
    promptLabel: "Prompt to copy into Copilot",
    fillDetails: "Fill in your details",
    openForm: "Open Submission Form",
    finalStep: "Final Step",
    submitTitle: "Submit your idea to Ruta de Innovacion 2026",
    submitDesc: "Copy Copilot's output and paste it into the submission form.",
    viewChallenges: "View the {{N}} challenges",
    comingSoonTitle: "This workshop will be available soon",
    comingSoonSub: "We're preparing the support material for your area. Check back soon!",
    backToSelector: "Back to selector",
    challengePrefix: "Challenge",
    loading: "Loading..."
  }
};

var workshopLang = "es";

function t(key) {
  return (I18N[workshopLang] && I18N[workshopLang][key]) || (I18N.en[key]) || key;
}

// -- SHORT TITLES --
var SHORT_TITLES_MAP = {
  es: ["Contexto", "Desafio", "Solucion", "Iterar", "Impacto", "Recursos", "Resumen"],
  en: ["Context", "Challenge", "Solution", "Iterate", "Impact", "Resources", "Summary"]
};

// -- STEPS_ES --
var STEPS_ES = [
  {
    id: 1,
    title: "Contexto",
    subtitle: "Configura tu co-creador con IA",
    duration: null,
    tip: { type: "action", text: 'Adjunta el archivo .md de la empresa a tu primer mensaje en Copilot. <a href="CONTEXTFILE" download style="color:inherit;font-weight:700;text-decoration:underline;">Descargalo aqui</a>.' },
    paths: null,
    fields: [
      { id: "name", label: "Tu nombre", placeholder: "Ej: Maria Gonzalez", multiline: false },
      { id: "role", label: "Tu rol, departamento y detalles clave", placeholder: "Ej: Coordinador de produccion en agua dulce, a cargo de 3 pisciculturas en la region de Los Lagos", multiline: true }
    ],
    prompt: "Eres un Experto en Innovacion y Acuicultura.\n\nSoy {{name}} y trabajo como {{role}}.\n\nEstoy participando en el Taller Avanzado de Ideacion 'Ruta de Innovacion 2026' de AquaChile, nuestro programa interno de innovacion.\n\nTu objetivo es ayudarme a generar una idea de innovacion de alto impacto para la empresa (que pueda impactar el EBITDA).\n\nComo contexto, te adjunto este archivo .md con informacion importante sobre nuestra empresa.\n\nQuiero que avancemos paso a paso y que no te adelantes con sugerencias \u2014 vamos a co-crear juntos. Nuestro primer paso es profundizar en un desafio y problema que he identificado.",
    fieldFallbacks: {
      name: "tu nombre",
      role: "tu rol, departamento y detalles clave sobre lo que haces"
    }
  },
  {
    id: 2,
    title: "Desafio y Problema",
    subtitle: "Define que quieres resolver",
    duration: "10 min",
    tip: { type: "tip", text: "Mientras mejor definas el problema, mejor sera tu solucion. Tomate tu tiempo aqui." },
    challengeRef: true,
    paths: [
      {
        id: "a",
        label: "Ya conozco mi problema",
        fields: [
          { id: "challenge2a", label: "El desafio que elegiste", placeholder: "Ej: Desafio #5: Automatizacion \u2014 Como podriamos digitalizar...", multiline: true },
          { id: "problem", label: "El problema u oportunidad que ves", placeholder: "Ej: Actualmente cada piscicultura gestiona sus datos de mortalidad en planillas distintas, causando retrasos en la deteccion de patrones...", multiline: true }
        ],
        prompt: "El desafio que me gustaria abordar es: {{challenge2a}}.\n\nAdemas, ya conozco un problema especifico dentro de este desafio que me interesa. Se trata de {{problem}}.\n\nHazme buenas preguntas para profundizar en este problema basandote en mi experiencia y conocimiento. Hazme 3\u20135 buenas preguntas para empezar y luego sigamos conversando.",
        fieldFallbacks: {
          challenge2a: "el desafio de la Ruta de Innovacion que quieres abordar",
          problem: "el problema u oportunidad que ves"
        }
      },
      {
        id: "b",
        label: "Ayudame a encontrar un problema",
        fields: [
          { id: "challenge2b", label: "El desafio que elegiste", placeholder: "Ej: Desafio #5: Automatizacion \u2014 Como podriamos digitalizar...", multiline: true }
        ],
        prompt: "El desafio que me gustaria abordar es: {{challenge2b}}.\n\nMe parece interesante este desafio, pero aun no he identificado un problema u oportunidad especifica.\n\nHazme buenas preguntas para identificar un problema u oportunidad especifica dentro de este desafio, basandote en mi experiencia y conocimiento. Hazme 3\u20135 buenas preguntas para empezar y luego sigamos conversando.",
        fieldFallbacks: {
          challenge2b: "el desafio de la Ruta de Innovacion que quieres abordar"
        }
      }
    ],
    fields: null,
    prompt: null,
    fieldFallbacks: null
  },
  {
    id: 3,
    title: "Solucion",
    subtitle: "Co-disena tu idea de innovacion",
    duration: "10 min",
    tip: { type: "tip", text: "Esta bien si tu idea es preliminar. Copilot te ayudara a refinarla." },
    paths: [
      {
        id: "a",
        label: "Ya tengo una idea",
        fields: [
          { id: "idea", label: "Tu idea preliminar", placeholder: "Ej: Un dashboard centralizado de datos de mortalidad en tiempo real que conecte todas las pisciculturas...", multiline: true }
        ],
        prompt: "Ahora que entendemos mejor el problema, pensemos en como resolverlo de una manera que genere un impacto positivo para los stakeholders y contribuya al EBITDA de la empresa.\n\nYa tengo una idea preliminar de solucion! Se trata de {{idea}}.\n\nHazme buenas preguntas para profundizar en esta idea. Quiero que la usemos como punto de partida para llegar a la mejor solucion posible.",
        fieldFallbacks: {
          idea: "la idea que tienes hasta ahora"
        }
      },
      {
        id: "b",
        label: "Necesito ayuda para idear",
        fields: [],
        prompt: "Ahora que entendemos mejor el problema, pensemos en como resolverlo de una manera que genere un impacto positivo para los stakeholders y contribuya al EBITDA de la empresa.\n\nAun no tengo una idea clara de como resolver este problema u oportunidad.\n\nAyudame a hacer brainstorming de diferentes formas de resolver el problema juntos.",
        fieldFallbacks: {}
      }
    ],
    fields: null,
    prompt: null,
    fieldFallbacks: null
  },
  {
    id: 4,
    title: "Iterar con Feedback",
    subtitle: "Integra el input de tu colega",
    duration: "5 min",
    tip: { type: "human", text: "Antes de usar este prompt: comparte tu idea con un colega (7 min cada uno). Trae aqui su mejor feedback." },
    paths: null,
    fields: [
      { id: "feedback", label: "El feedback de tu colega (los puntos que mas te resonaron)", placeholder: "Ej: Sugirio enfocarse primero en smolts porque es donde hay mas mortalidad temprana. Tambien recomendo integrar con el sistema SAP existente...", multiline: true }
    ],
    prompt: "Acabo de reunirme con un colega que me dio excelente feedback. Esto es lo que dijo:\n\n{{feedback}}\n\nTu Tarea:\n- Analiza como este feedback cambia o mejora la solucion original.\n- Propon como integrar esta sugerencia sin perder factibilidad tecnica.\n- Preguntame: '\u00bfEsta nueva version se ajusta a tu solucion, o quieres seguir iterando?'",
    fieldFallbacks: {
      feedback: "ESCRIBE AQUI LOS PUNTOS DE FEEDBACK QUE MAS TE RESONARON"
    }
  },
  {
    id: 5,
    title: "Impacto y Beneficios",
    subtitle: "Construye el caso economico",
    duration: "10 min",
    tip: { type: "tip", text: "Copilot pensara como un CFO. Sin numeros inventados \u2014 solo logica economica que puedas defender." },
    paths: null,
    fields: [],
    prompt: "Ahora actua como el CFO de AquaChile: con vision de negocio, enfocado en rentabilidad y tambien en gestion de riesgos.\n\nQuiero que me ayudes a entender el impacto potencial de mi idea porque necesitare defender la inversion demostrando su retorno. No me des numeros inventados. Ayudame a construir la logica economica.\n\n- Conexion con EBITDA: Analiza mi solucion y explica paso a paso como esta mejora impacta el Estado de Resultados.\n- Datos Clave: Piensa y lista los datos clave que necesito recopilar para validar el impacto en EBITDA de mi idea.\n- Potenciador de Rentabilidad: Dame un consejo \u2014 \u00bfque pequena modificacion podria hacer a mi idea para aumentar aun mas su impacto en EBITDA?",
    fieldFallbacks: {}
  },
  {
    id: 6,
    title: "Recursos",
    subtitle: "\u00bfQue necesitas para hacerlo realidad?",
    duration: "5 min",
    tip: { type: "tip", text: "Piensa en costos ocultos: capacitacion, gestion del cambio, mantencion, integraciones." },
    paths: null,
    fields: [],
    prompt: "Actua como un Gerente Senior de Implementacion de Proyectos.\n\nTU TAREA: Tu objetivo es desglosar la \"Lista de Compras\" real para que este proyecto funcione, asegurando que no me falte ningun costo o recurso oculto.\n\nINSTRUCCIONES:\n- Analiza mi solucion: Identifica si requiere Hardware, Software, Personas, Capacitacion o Cambios de Infraestructura.\n- El Interrogatorio: No me hagas preguntas genericas. Basandote en mi idea especifica, hazme 3 buenas preguntas sobre recursos que probablemente no considere.",
    fieldFallbacks: {}
  },
  {
    id: 7,
    title: "Compilacion Final",
    subtitle: "Obten tu resumen listo para postular",
    duration: "5 min",
    tip: { type: "action", text: "Este es el ultimo prompt. Compila todo para el formulario de postulacion de la Ruta de Innovacion." },
    paths: null,
    fields: [],
    prompt: "Ahora actua como un Experto en Formulacion de Proyectos de Innovacion.\n\nDurante esta sesion hemos definido mi problema raiz, mi solucion tecnica, los recursos necesarios y la estimacion de impacto.\n\nPor favor compila toda la informacion de nuestra conversacion y redacta las respuestas finales para el formulario que usaremos para postular nuestra idea. Usa un lenguaje ejecutivo, persuasivo y directo.\n\nCOMPLETA ESTOS CAMPOS (y sugiere un titulo):\n- DESAFIO Y PROBLEMA: Resume \u2014 \u00bfQue problema observaste? \u00bfDonde ocurre? \u00bfY por que es critico resolverlo?\n- DESCRIBE TU IDEA: Explica de forma simple \u2014 \u00bfQue es? \u00bfY como funciona tecnicamente?\n- IMPACTO Y BENEFICIOS: Escribe la logica de valor. \u00bfComo genera valor para AquaChile?\n- RECURSOS Y ESFUERZO: Lista lo que se necesita (Personas, tiempo, equipamiento) y el nivel de costo estimado.",
    fieldFallbacks: {},
    isSubmitStep: true
  }
];

// -- STEPS_EN (copied exactly from legacy workshop) --
var STEPS_EN = [
  {
    id: 1,
    title: "Context",
    subtitle: "Set up your AI co-creator",
    duration: null,
    tip: { type: "action", text: 'Attach the company .md file to your first message in Copilot. <a href="CONTEXTFILE" download style="color:inherit;font-weight:700;text-decoration:underline;">Download it here</a>.' },
    paths: null,
    fields: [
      { id: "name", label: "Your name", placeholder: "e.g., Maria Gonzalez", multiline: false },
      { id: "role", label: "Your role, department & key details", placeholder: "e.g., Sales Coordinator in the Commercial team, based in Miami, responsible for US East Coast clients", multiline: true }
    ],
    prompt: "You are an Expert in Innovation and Aquaculture.\n\nI am {{name}} and I work as {{role}}.\n\nI'm participating in the Advanced Ideation Workshop 'Innovation Route 2026' at AquaChile, our internal innovation program.\n\nYour goal is to help me generate a high-impact innovation idea for the company (one that can impact EBITDA).\n\nAs context, I'm attaching this .md file with important information about our company.\n\nI want us to move step by step and for you not to jump ahead with suggestions \u2014 we'll co-create together. Our first step is to dive deeper into a challenge and problem I've identified.",
    fieldFallbacks: {
      name: "your name",
      role: "your role, department, and key details about what you do"
    }
  },
  {
    id: 2,
    title: "Challenge & Problem",
    subtitle: "Define what you want to solve",
    duration: "10 min",
    tip: { type: "tip", text: "The better you define the problem, the better your solution will be. Take your time here." },
    challengeRef: true,
    paths: [
      {
        id: "a",
        label: "I already know my problem",
        fields: [
          { id: "challenge2a", label: "The challenge you chose", placeholder: "e.g., Challenge #5: Inventory Management \u2014 How might we standardize...", multiline: true },
          { id: "problem", label: "The problem or opportunity you see", placeholder: "e.g., Currently each branch manages frozen inventory with different spreadsheets, causing stock discrepancies and lost sales...", multiline: true }
        ],
        prompt: "The challenge I'd like to tackle is: {{challenge2a}}.\n\nAlso, I already know a specific problem within this challenge that interests me. It's about {{problem}}.\n\nAsk me good questions to dive deeper into this problem based on my experience and knowledge. Ask me 3\u20135 good questions to start and then let's keep talking!",
        fieldFallbacks: {
          challenge2a: "the Innovation Route challenge you want to address",
          problem: "the problem or opportunity you see"
        }
      },
      {
        id: "b",
        label: "Help me find a problem",
        fields: [
          { id: "challenge2b", label: "The challenge you chose", placeholder: "e.g., Challenge #5: Inventory Management \u2014 How might we standardize...", multiline: true }
        ],
        prompt: "The challenge I'd like to tackle is: {{challenge2b}}.\n\nI find this challenge interesting, but I haven't yet identified a specific problem or opportunity.\n\nAsk me good questions to identify a specific problem or opportunity within this challenge, based on my experience and knowledge. Ask me 3\u20135 good questions to start and then let's keep talking!",
        fieldFallbacks: {
          challenge2b: "the Innovation Route challenge you want to address"
        }
      }
    ],
    fields: null,
    prompt: null,
    fieldFallbacks: null
  },
  {
    id: 3,
    title: "Solution",
    subtitle: "Co-design your innovation idea",
    duration: "10 min",
    tip: { type: "tip", text: "It's OK if your idea is rough. Copilot will help you refine it." },
    paths: [
      {
        id: "a",
        label: "I already have an idea",
        fields: [
          { id: "idea", label: "Your preliminary idea", placeholder: "e.g., A centralized real-time inventory dashboard that connects all branches via a single API...", multiline: true }
        ],
        prompt: "Now that we better understand the problem, let's think about how to solve it in a way that creates a positive impact for stakeholders and contributes to the company's EBITDA.\n\nI already have a preliminary solution idea! It's about {{idea}}.\n\nAsk me good questions to go deeper into this idea. I want us to use it as a starting point to reach the best possible solution.",
        fieldFallbacks: {
          idea: "the idea you have so far"
        }
      },
      {
        id: "b",
        label: "I need help brainstorming",
        fields: [],
        prompt: "Now that we better understand the problem, let's think about how to solve it in a way that creates a positive impact for stakeholders and contributes to the company's EBITDA.\n\nI don't have a clear idea yet of how to solve this problem or opportunity.\n\nHelp me brainstorm different ways to solve the problem together.",
        fieldFallbacks: {}
      }
    ],
    fields: null,
    prompt: null,
    fieldFallbacks: null
  },
  {
    id: 4,
    title: "Iterate with Feedback",
    subtitle: "Integrate your colleague's input",
    duration: "5 min",
    tip: { type: "human", text: "Before using this prompt: share your idea with a colleague (7 min each). Bring their best feedback here." },
    paths: null,
    fields: [
      { id: "feedback", label: "Your colleague's feedback (the points that resonated most)", placeholder: "e.g., She suggested focusing on frozen products first since that's where most discrepancies happen. Also recommended integrating with the existing SAP system rather than building from scratch...", multiline: true }
    ],
    prompt: "I just met with a colleague who gave me excellent feedback. Here's what they said:\n\n{{feedback}}\n\nYour Task:\n- Analyze how this feedback changes or improves the original solution.\n- Propose how to integrate this suggestion without losing technical feasibility.\n- Ask me: 'Does this new version fit your solution, or do you want to keep iterating?'",
    fieldFallbacks: {
      feedback: "WRITE HERE THE FEEDBACK POINTS THAT RESONATED MOST WITH YOU"
    }
  },
  {
    id: 5,
    title: "Impact & Benefits",
    subtitle: "Build the economic case",
    duration: "10 min",
    tip: { type: "tip", text: "Copilot will think like a CFO. No made-up numbers \u2014 just economic logic you can defend." },
    paths: null,
    fields: [],
    prompt: "Now act as AquaChile's CFO: with a business vision, focused on profitability and also on risk management.\n\nI want you to help me understand the potential impact of my idea because I'll need to defend the investment by demonstrating its return. Don't give me made-up numbers. Help me build the economic logic.\n\n- EBITDA Connection: Analyze my solution and explain step by step how this improvement impacts the Income Statement.\n- Key Data: Think about and list the key data I need to gather to validate the EBITDA impact of my idea.\n- Profitability Booster: Give me advice \u2014 what small modification could I make to my idea to increase its EBITDA impact even further?",
    fieldFallbacks: {}
  },
  {
    id: 6,
    title: "Resources",
    subtitle: "What do you need to make it happen?",
    duration: "5 min",
    tip: { type: "tip", text: "Think about hidden costs: training, change management, maintenance, integrations." },
    paths: null,
    fields: [],
    prompt: "Act as a Senior Project Implementation Manager.\n\nYOUR TASK: Your goal is to break down the real \"Shopping List\" to make this project work, ensuring I don't miss any hidden costs or resources.\n\nINSTRUCTIONS:\n- Analyze my solution: Identify if it requires Hardware, Software, People, Training, or Infrastructure Changes.\n- The Interrogation: Don't ask me generic questions. Based on my specific idea, ask me 3 good questions about resources I probably didn't consider.",
    fieldFallbacks: {}
  },
  {
    id: 7,
    title: "Final Compilation",
    subtitle: "Get your submission-ready summary",
    duration: "5 min",
    tip: { type: "action", text: "This is the last prompt. It compiles everything for the Innovation Route submission form." },
    paths: null,
    fields: [],
    prompt: "Now act as an Expert in Innovation Project Formulation.\n\nDuring this session we've defined my root problem, my technical solution, the required resources, and the impact estimate.\n\nPlease compile all the information from our conversation and draft the final answers for the form we'll use to submit our idea. Use executive, persuasive, and direct language.\n\nCOMPLETE THESE FIELDS (and suggest a title):\n- CHALLENGE & PROBLEM: Summarize \u2014 What problem did you observe? Where does it occur? And why is it critical to solve?\n- DESCRIBE YOUR IDEA: Explain simply \u2014 What is it? And how does it work technically?\n- IMPACT & BENEFITS: Write the value logic. How does it generate value for AquaChile?\n- RESOURCES & EFFORT: List what's needed (People, time, equipment) and the estimated cost level.",
    fieldFallbacks: {},
    isSubmitStep: true
  }
];

// =====================================================
// LOADING SEQUENCE
// =====================================================

var WORKSHOP = null;
var STEPS = [];
var SHORT_TITLES = [];
var CHALLENGES = [];

(function loadWorkshop() {
  // 1. Parse ?w= from URL
  var params = new URLSearchParams(window.location.search);
  var workshopId = params.get('w');

  if (!workshopId) {
    window.location.href = 'index.html';
    return;
  }

  // 2. Load data file
  var script = document.createElement('script');
  script.src = 'data/' + workshopId + '.js';
  script.onload = function() {
    initWorkshop();
  };
  script.onerror = function() {
    document.getElementById('step-content').innerHTML =
      '<div class="loading-container">No se encontro el taller "' + workshopId + '". <a href="index.html">Volver</a></div>';
  };
  document.head.appendChild(script);
})();

function initWorkshop() {
  WORKSHOP = window.WORKSHOP_DATA;
  if (!WORKSHOP) {
    document.getElementById('step-content').innerHTML =
      '<div class="loading-container">Error al cargar datos. <a href="index.html">Volver</a></div>';
    return;
  }

  // Set language
  workshopLang = WORKSHOP.lang || "es";
  document.documentElement.lang = workshopLang === "en" ? "en" : "es";
  document.title = t('headerTitle') + ' \u2014 AquaChile | ' + WORKSHOP.title;

  // Update header
  document.getElementById('header-title').textContent = t('headerTitle');
  document.getElementById('area-subtitle').textContent = WORKSHOP.area + ' \u00b7 ' + WORKSHOP.title;

  // Select STEPS based on language
  STEPS = workshopLang === "en" ? STEPS_EN : STEPS_ES;
  SHORT_TITLES = SHORT_TITLES_MAP[workshopLang] || SHORT_TITLES_MAP.es;
  CHALLENGES = WORKSHOP.challenges || [];

  // Patch context file link in Step 1 tip
  if (STEPS[0] && STEPS[0].tip && WORKSHOP.contextFile) {
    STEPS[0].tip.text = STEPS[0].tip.text.replace('CONTEXTFILE', WORKSHOP.contextFile);
  }

  // Patch submitUrl into last step
  if (WORKSHOP.submitUrl) {
    STEPS[STEPS.length - 1].submitUrl = WORKSHOP.submitUrl;
  }

  // Handle coming soon
  if (WORKSHOP.comingSoon) {
    renderComingSoon();
    return;
  }

  // Show step nav and render
  document.getElementById('step-nav-wrapper').style.display = '';
  render();
}

function renderComingSoon() {
  document.getElementById('step-nav-wrapper').style.display = 'none';
  var container = document.getElementById('step-content');
  container.innerHTML = '<div class="coming-soon-container fade-in">' +
    '<h1>' + t('comingSoonTitle') + '</h1>' +
    '<p>' + t('comingSoonSub') + '</p>' +
    '<a class="back-btn" href="index.html">' + t('backToSelector') + '</a>' +
    '</div>';
}

// =====================================================
// STATE
// =====================================================

var currentStep = 0;
var activePaths = { 2: "a", 3: "a" };
var fieldValues = {};
var challengePanelOpen = false;

// =====================================================
// RENDER
// =====================================================

function renderNav() {
  var nav = document.getElementById('step-nav');
  nav.innerHTML = STEPS.map(function(step, i) {
    return '<button class="step-pill ' + (i === currentStep ? 'active' : '') + '" onclick="goToStep(' + i + ')">' +
      '<span class="step-num">' + step.id + '</span>' +
      '<span class="step-label">' + SHORT_TITLES[i] + '</span>' +
      '</button>';
  }).join('');
}

function render() {
  renderNav();
  var container = document.getElementById('step-content');
  var step = STEPS[currentStep];
  var isPathStep = step.paths !== null;
  var activePath = isPathStep ? step.paths.find(function(p) { return p.id === activePaths[step.id]; }) : null;

  var fields = isPathStep ? (activePath ? activePath.fields : []) : (step.fields || []);
  var promptTemplate = isPathStep ? (activePath ? activePath.prompt : '') : step.prompt;
  var fallbacks = isPathStep ? (activePath ? activePath.fieldFallbacks || {} : {}) : (step.fieldFallbacks || {});

  var html = '<div class="fade-in">';

  // Step header
  html += '<div class="step-header">' +
    '<div class="step-header-top">' +
    '<span class="step-number">' + t('step') + ' ' + step.id + '</span>' +
    (step.duration ? '<span class="step-duration">' + step.duration + '</span>' : '') +
    '</div>' +
    '<h1 class="step-title">' + step.title + '</h1>' +
    '<p class="step-subtitle">' + step.subtitle + '</p>' +
    '</div>';

  // Callout / tip
  if (step.tip) {
    var calloutLabel = step.tip.type === 'tip' ? t('tipLabel') : (step.tip.type === 'action' ? t('actionLabel') : t('humanLabel'));
    html += '<div class="callout callout-' + step.tip.type + '">' +
      '<strong>' + calloutLabel + ':</strong> ' + step.tip.text +
      '</div>';
  }

  // Challenge reference (step 2)
  if (step.challengeRef) {
    html += renderChallengeRef();
  }

  // Path toggle
  if (isPathStep) {
    html += '<div class="path-toggle">';
    step.paths.forEach(function(p) {
      html += '<button class="path-btn ' + (activePaths[step.id] === p.id ? 'active' : '') + '" ' +
        'onclick="togglePath(' + step.id + ', \'' + p.id + '\')">' +
        p.label +
        '</button>';
    });
    html += '</div>';
  }

  // Fields section
  if (fields.length > 0) {
    html += '<div class="fields-section">' +
      '<div class="fields-title">' + t('fillDetails') + '</div>';
    fields.forEach(function(f) {
      html += '<div class="field-group">' +
        '<label class="field-label" for="field-' + f.id + '">' + f.label + '</label>';
      if (f.multiline) {
        html += '<textarea class="field-textarea" id="field-' + f.id + '" placeholder="' + f.placeholder + '" oninput="onFieldInput(\'' + f.id + '\', this.value)">' + (fieldValues[f.id] || '') + '</textarea>';
      } else {
        html += '<input class="field-input" type="text" id="field-' + f.id + '" placeholder="' + f.placeholder + '" value="' + (fieldValues[f.id] || '') + '" oninput="onFieldInput(\'' + f.id + '\', this.value)">';
      }
      html += '</div>';
    });
    html += '</div>';
  }

  // Prompt card
  var assembledPrompt = assemblePrompt(promptTemplate, fallbacks);
  var displayPrompt = assemblePromptHTML(promptTemplate, fallbacks);

  html += '<div class="prompt-card">' +
    '<div class="prompt-card-header">' +
    '<span class="prompt-card-label">' + t('promptLabel') + '</span>' +
    '<button class="copy-btn" id="copy-btn" onclick="copyPrompt()">' +
    '<svg id="copy-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">' +
    '<rect x="5" y="5" width="9" height="9" rx="1.5"/>' +
    '<path d="M11 5V3.5A1.5 1.5 0 009.5 2h-6A1.5 1.5 0 002 3.5v6A1.5 1.5 0 003.5 11H5"/>' +
    '</svg>' +
    '<span id="copy-text">' + t('copy') + '</span>' +
    '</button>' +
    '</div>' +
    '<div class="prompt-text" id="prompt-display">' + displayPrompt + '</div>' +
    '</div>';

  // Submit CTA (final step only)
  if (step.submitUrl) {
    html += '<div class="submit-cta" id="submit-cta">' +
      '<div class="submit-cta-label">' + t('finalStep') + '</div>' +
      '<div class="submit-cta-title">' + t('submitTitle') + '</div>' +
      '<div class="submit-cta-desc">' + t('submitDesc') + '</div>' +
      '<a class="submit-cta-btn" id="submit-btn" href="' + step.submitUrl + '" target="_blank" rel="noopener" onclick="launchFireworks(event)">' +
      t('openForm') +
      '</a>' +
      '</div>';
  }

  // Navigation buttons
  html += '<div class="step-nav-btns">' +
    '<button class="nav-btn" onclick="goToStep(' + (currentStep - 1) + ')" ' + (currentStep === 0 ? 'disabled' : '') + '>' +
    t('prev') +
    '</button>';
  if (currentStep < STEPS.length - 1) {
    html += '<button class="nav-btn nav-btn-next" onclick="goToStep(' + (currentStep + 1) + ')">' + t('next') + '</button>';
  }
  html += '</div>';

  html += '</div>';
  container.innerHTML = html;
}

function renderChallengeRef() {
  var totalChallenges = 0;
  CHALLENGES.forEach(function(p) { totalChallenges += p.items.length; });
  var viewLabel = t('viewChallenges').replace('{{N}}', totalChallenges);

  var html = '<div class="challenge-ref">' +
    '<button class="challenge-toggle ' + (challengePanelOpen ? 'open' : '') + '" onclick="toggleChallenges()">' +
    '<span class="arrow">\u25B6</span> ' + viewLabel +
    '</button>' +
    '<div class="challenge-panel ' + (challengePanelOpen ? 'open' : '') + '">';

  CHALLENGES.forEach(function(pillar) {
    html += '<div class="challenge-pillar">' +
      '<div class="pillar-name">' + pillar.pillar + '</div>';
    pillar.items.forEach(function(c) {
      html += '<div class="challenge-item" onclick="pickChallenge(' + c.num + ', \'' + c.title.replace(/'/g, "\\'") + '\', this)">' +
        '<strong>#' + c.num + ' ' + c.title + ':</strong> ' + c.hmw +
        '</div>';
    });
    html += '</div>';
  });

  html += '</div></div>';
  return html;
}

// =====================================================
// PROMPT ASSEMBLY
// =====================================================

function assemblePrompt(template, fallbacks) {
  if (!template) return '';
  return template.replace(/\{\{(\w+)\}\}/g, function(match, id) {
    var value = fieldValues[id] ? fieldValues[id].trim() : '';
    return value || '[' + (fallbacks[id] || id) + ']';
  });
}

function assemblePromptHTML(template, fallbacks) {
  if (!template) return '';
  var escaped = template
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  return escaped.replace(/\{\{(\w+)\}\}/g, function(match, id) {
    var value = fieldValues[id] ? fieldValues[id].trim() : '';
    if (value) {
      return '<span class="field-highlight">' + value.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
    }
    return '<span class="field-highlight">[' + (fallbacks[id] || id) + ']</span>';
  });
}

// =====================================================
// ACTIONS
// =====================================================

function goToStep(index) {
  if (index < 0 || index >= STEPS.length) return;
  currentStep = index;
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function togglePath(stepId, pathId) {
  activePaths[stepId] = pathId;
  render();
}

function onFieldInput(fieldId, value) {
  fieldValues[fieldId] = value;
  // Live-update prompt display without full re-render
  var step = STEPS[currentStep];
  var isPathStep = step.paths !== null;
  var activePath = isPathStep ? step.paths.find(function(p) { return p.id === activePaths[step.id]; }) : null;
  var template = isPathStep ? (activePath ? activePath.prompt : '') : step.prompt;
  var fallbacks = isPathStep ? (activePath ? activePath.fieldFallbacks || {} : {}) : (step.fieldFallbacks || {});
  var display = document.getElementById('prompt-display');
  if (display && template) {
    display.innerHTML = assemblePromptHTML(template, fallbacks);
  }
}

function toggleChallenges() {
  challengePanelOpen = !challengePanelOpen;
  var toggle = document.querySelector('.challenge-toggle');
  var panel = document.querySelector('.challenge-panel');
  if (toggle) toggle.classList.toggle('open');
  if (panel) panel.classList.toggle('open');
}

function pickChallenge(num, title, el) {
  var step = STEPS[currentStep];
  var pathId = activePaths[step.id];
  var fieldId = pathId === 'a' ? 'challenge2a' : 'challenge2b';
  var challenge = null;
  CHALLENGES.forEach(function(p) {
    p.items.forEach(function(c) {
      if (c.num === num) challenge = c;
    });
  });
  var prefix = t('challengePrefix');
  var text = prefix + ' #' + num + ': ' + title + ' \u2014 ' + challenge.hmw;
  fieldValues[fieldId] = text;
  var input = document.getElementById('field-' + fieldId);
  if (input) input.value = text;
  onFieldInput(fieldId, text);
  challengePanelOpen = false;
  render();
}

async function copyPrompt() {
  var step = STEPS[currentStep];
  var isPathStep = step.paths !== null;
  var activePath = isPathStep ? step.paths.find(function(p) { return p.id === activePaths[step.id]; }) : null;
  var template = isPathStep ? (activePath ? activePath.prompt : '') : step.prompt;
  var fallbacks = isPathStep ? (activePath ? activePath.fieldFallbacks || {} : {}) : (step.fieldFallbacks || {});
  var text = assemblePrompt(template, fallbacks);

  try {
    await navigator.clipboard.writeText(text);
    var btn = document.getElementById('copy-btn');
    var icon = document.getElementById('copy-icon');
    var label = document.getElementById('copy-text');
    btn.classList.add('copied');
    label.textContent = t('copied');
    icon.innerHTML = '<polyline points="4 8 7 11 12 5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
    setTimeout(function() {
      btn.classList.remove('copied');
      label.textContent = t('copy');
      icon.innerHTML = '<rect x="5" y="5" width="9" height="9" rx="1.5"/><path d="M11 5V3.5A1.5 1.5 0 009.5 2h-6A1.5 1.5 0 002 3.5v6A1.5 1.5 0 003.5 11H5"/>';
    }, 2000);
  } catch (err) {
    // Fallback for older browsers
    var textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
  }
}

// =====================================================
// CELEBRATION ENGINE
// =====================================================

var CONFETTI_COLORS = ['#FF7600', '#FFa040', '#FFcc33', '#65bd7d', '#198fd9', '#ff4d6a', '#a855f7', '#ffffff'];
var CELEBRATION_EMOJIS = ['\uD83C\uDF89', '\uD83D\uDE80', '\uD83C\uDFC6', '\u2B50', '\uD83C\uDF8A', '\uD83D\uDCA1', '\uD83D\uDD25', '\u2728', '\uD83E\uDD47', '\uD83D\uDCAA'];

var celebrationCanvas = null;
var celebrationCtx = null;
var particles = [];
var fireworkParticles = [];
var animationId = null;
var partyMode = false;
var partyInterval = null;

function ensureCanvas() {
  if (celebrationCanvas) return;
  celebrationCanvas = document.createElement('canvas');
  celebrationCanvas.id = 'celebration-canvas';
  document.body.appendChild(celebrationCanvas);
  celebrationCtx = celebrationCanvas.getContext('2d');
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
}

function resizeCanvas() {
  if (!celebrationCanvas) return;
  celebrationCanvas.width = window.innerWidth;
  celebrationCanvas.height = window.innerHeight;
}

// Confetti particle
function createConfetti(x, y, count) {
  for (var i = 0; i < count; i++) {
    var angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5);
    var velocity = 4 + Math.random() * 8;
    particles.push({
      x: x, y: y,
      vx: Math.cos(angle) * velocity * (0.5 + Math.random()),
      vy: Math.sin(angle) * velocity * (0.5 + Math.random()) - 3,
      w: 4 + Math.random() * 6,
      h: 6 + Math.random() * 8,
      color: CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)],
      rotation: Math.random() * 360,
      rotSpeed: (Math.random() - 0.5) * 12,
      gravity: 0.12 + Math.random() * 0.08,
      drag: 0.98,
      opacity: 1,
      life: 160 + Math.random() * 80,
      age: 0,
      type: Math.random() > 0.3 ? 'rect' : 'circle'
    });
  }
}

// Firework burst
function createFirework(x, y) {
  var color = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
  var sparkCount = 50 + Math.floor(Math.random() * 40);
  for (var i = 0; i < sparkCount; i++) {
    var angle = (Math.PI * 2 * i) / sparkCount + (Math.random() - 0.5) * 0.3;
    var velocity = 2 + Math.random() * 5;
    fireworkParticles.push({
      x: x, y: y,
      vx: Math.cos(angle) * velocity,
      vy: Math.sin(angle) * velocity,
      radius: 1.5 + Math.random() * 2,
      color: color,
      opacity: 1,
      life: 50 + Math.random() * 40,
      age: 0,
      gravity: 0.04,
      trail: []
    });
  }
}

// Rocket that goes up then bursts
function launchRocket(x) {
  var targetY = 80 + Math.random() * (window.innerHeight * 0.3);
  fireworkParticles.push({
    x: x, y: window.innerHeight + 10,
    vx: (Math.random() - 0.5) * 1.5,
    vy: -(8 + Math.random() * 4),
    radius: 3,
    color: '#FFcc33',
    opacity: 1,
    life: 999,
    age: 0,
    gravity: 0.04,
    isRocket: true,
    targetY: targetY,
    trail: []
  });
}

function spawnFloatingEmoji(x, y) {
  var emoji = document.createElement('div');
  emoji.className = 'emoji-float';
  emoji.textContent = CELEBRATION_EMOJIS[Math.floor(Math.random() * CELEBRATION_EMOJIS.length)];
  emoji.style.left = (x + (Math.random() - 0.5) * 200) + 'px';
  emoji.style.top = y + 'px';
  emoji.style.fontSize = (1.5 + Math.random() * 1.5) + 'rem';
  document.body.appendChild(emoji);
  setTimeout(function() { emoji.remove(); }, 3000);
}

function flashScreen() {
  var flash = document.createElement('div');
  flash.className = 'screen-flash';
  document.body.appendChild(flash);
  setTimeout(function() { flash.remove(); }, 600);
}

function animateCelebration() {
  if (!celebrationCtx) return;
  celebrationCtx.clearRect(0, 0, celebrationCanvas.width, celebrationCanvas.height);

  // Draw confetti
  for (var i = particles.length - 1; i >= 0; i--) {
    var p = particles[i];
    p.age++;
    p.vx *= p.drag;
    p.vy += p.gravity;
    p.vy *= 0.995;
    p.x += p.vx;
    p.y += p.vy;
    p.rotation += p.rotSpeed;
    if (p.age > p.life * 0.7) p.opacity = Math.max(0, 1 - (p.age - p.life * 0.7) / (p.life * 0.3));
    if (p.age > p.life) { particles.splice(i, 1); continue; }

    celebrationCtx.save();
    celebrationCtx.translate(p.x, p.y);
    celebrationCtx.rotate(p.rotation * Math.PI / 180);
    celebrationCtx.globalAlpha = p.opacity;
    celebrationCtx.fillStyle = p.color;
    if (p.type === 'circle') {
      celebrationCtx.beginPath();
      celebrationCtx.arc(0, 0, p.w / 2, 0, Math.PI * 2);
      celebrationCtx.fill();
    } else {
      celebrationCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
    }
    celebrationCtx.restore();
  }

  // Draw firework sparks
  for (var i = fireworkParticles.length - 1; i >= 0; i--) {
    var p = fireworkParticles[i];
    p.age++;
    p.vy += p.gravity;
    p.x += p.vx;
    p.y += p.vy;

    // Rocket logic
    if (p.isRocket) {
      // Trail
      celebrationCtx.beginPath();
      celebrationCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      celebrationCtx.fillStyle = p.color;
      celebrationCtx.globalAlpha = 1;
      celebrationCtx.fill();
      // Rocket trail sparks
      for (var tt = 0; tt < 2; tt++) {
        particles.push({
          x: p.x + (Math.random() - 0.5) * 4,
          y: p.y,
          vx: (Math.random() - 0.5) * 1,
          vy: 1 + Math.random() * 2,
          w: 2, h: 2,
          color: Math.random() > 0.5 ? '#FFcc33' : '#FF7600',
          rotation: 0, rotSpeed: 0,
          gravity: 0.02, drag: 0.97,
          opacity: 1, life: 20 + Math.random() * 15, age: 0,
          type: 'circle'
        });
      }
      if (p.y <= p.targetY) {
        createFirework(p.x, p.y);
        fireworkParticles.splice(i, 1);
      }
      continue;
    }

    // Trail
    p.trail.push({ x: p.x, y: p.y });
    if (p.trail.length > 6) p.trail.shift();

    if (p.age > p.life * 0.5) p.opacity = Math.max(0, 1 - (p.age - p.life * 0.5) / (p.life * 0.5));
    if (p.age > p.life) { fireworkParticles.splice(i, 1); continue; }

    // Draw trail
    if (p.trail.length > 1) {
      celebrationCtx.beginPath();
      celebrationCtx.moveTo(p.trail[0].x, p.trail[0].y);
      for (var tt = 1; tt < p.trail.length; tt++) {
        celebrationCtx.lineTo(p.trail[tt].x, p.trail[tt].y);
      }
      celebrationCtx.strokeStyle = p.color;
      celebrationCtx.globalAlpha = p.opacity * 0.3;
      celebrationCtx.lineWidth = p.radius * 0.8;
      celebrationCtx.stroke();
    }

    celebrationCtx.beginPath();
    celebrationCtx.arc(p.x, p.y, p.radius * (0.5 + p.opacity * 0.5), 0, Math.PI * 2);
    celebrationCtx.fillStyle = p.color;
    celebrationCtx.globalAlpha = p.opacity;
    celebrationCtx.fill();
  }

  celebrationCtx.globalAlpha = 1;

  if (particles.length > 0 || fireworkParticles.length > 0 || partyMode) {
    animationId = requestAnimationFrame(animateCelebration);
  } else {
    if (celebrationCanvas) {
      celebrationCtx.clearRect(0, 0, celebrationCanvas.width, celebrationCanvas.height);
    }
  }
}

function startPartyMode() {
  if (partyMode) return;
  partyMode = true;
  var w = function() { return window.innerWidth; };
  var h = function() { return window.innerHeight; };

  // Endless rockets every 1.2s
  partyInterval = setInterval(function() {
    launchRocket(w() * 0.1 + Math.random() * w() * 0.8);
    if (Math.random() > 0.4) launchRocket(w() * 0.1 + Math.random() * w() * 0.8);
  }, 1200);

  // Confetti bursts from random edges every 2s
  setInterval(function() {
    if (!partyMode) return;
    var side = Math.floor(Math.random() * 4);
    if (side === 0) createConfetti(Math.random() * w(), 0, 40);
    else if (side === 1) createConfetti(w(), Math.random() * h(), 40);
    else if (side === 2) createConfetti(Math.random() * w(), h(), 40);
    else createConfetti(0, Math.random() * h(), 40);
  }, 2000);

  // Emoji rain every 800ms
  setInterval(function() {
    if (!partyMode) return;
    spawnFloatingEmoji(Math.random() * w(), h() * 0.2 + Math.random() * h() * 0.5);
  }, 800);
}

function startCelebrationLoop() {
  if (animationId) cancelAnimationFrame(animationId);
  animationId = requestAnimationFrame(animateCelebration);
}

// Confetti burst when step 7 loads
function celebrateStepLoad() {
  ensureCanvas();
  var cta = document.getElementById('submit-cta');
  if (!cta) return;
  var rect = cta.getBoundingClientRect();
  var cx = rect.left + rect.width / 2;
  var cy = rect.top + rect.height / 2;

  // Staggered confetti bursts
  createConfetti(cx, cy, 60);
  setTimeout(function() { createConfetti(cx - 100, cy - 20, 30); }, 200);
  setTimeout(function() { createConfetti(cx + 100, cy - 20, 30); }, 400);

  // Floating emojis
  for (var i = 0; i < 8; i++) {
    (function(idx) {
      setTimeout(function() { spawnFloatingEmoji(cx, cy); }, idx * 150);
    })(i);
  }

  startCelebrationLoop();
}

// Full fireworks show on submit click
function launchFireworks(e) {
  ensureCanvas();
  flashScreen();

  var w = window.innerWidth;

  // Wave 1: immediate burst from click position
  var rect = e.target.getBoundingClientRect();
  var cx = rect.left + rect.width / 2;
  var cy = rect.top + rect.height / 2;
  createConfetti(cx, cy, 100);

  // Floating emojis rain
  for (var i = 0; i < 15; i++) {
    (function(idx) {
      setTimeout(function() {
        spawnFloatingEmoji(
          Math.random() * w,
          window.innerHeight * 0.3 + Math.random() * window.innerHeight * 0.4
        );
      }, idx * 200);
    })(i);
  }

  // Wave 2: rockets from bottom
  for (var i = 0; i < 5; i++) {
    (function(idx) {
      setTimeout(function() {
        launchRocket(w * 0.15 + Math.random() * w * 0.7);
      }, 300 + idx * 400);
    })(i);
  }

  // Wave 3: more rockets
  for (var i = 0; i < 4; i++) {
    (function(idx) {
      setTimeout(function() {
        launchRocket(w * 0.1 + Math.random() * w * 0.8);
      }, 2200 + idx * 350);
    })(i);
  }

  // Wave 4: confetti cannons from sides
  setTimeout(function() {
    createConfetti(0, window.innerHeight * 0.4, 80);
    createConfetti(w, window.innerHeight * 0.4, 80);
  }, 1500);

  setTimeout(function() {
    createConfetti(w / 2, 0, 120);
  }, 2800);

  // After the initial show, keep the party going forever
  setTimeout(function() { startPartyMode(); }, 3500);

  startCelebrationLoop();
}

// Hook into step rendering to trigger confetti on step 7
var _originalRender = render;
render = function() {
  _originalRender();
  if (STEPS[currentStep] && STEPS[currentStep].submitUrl) {
    setTimeout(celebrateStepLoad, 400);
  }
};
</script>
</body>
</html>
